# Repository Review

## Overview

This is a **Flux CD GitOps repository** for a single-node **k3s cluster** running on **openSUSE Leap Micro 6.2**. It manages two application groups:

- **Media stack**: Plex, Sonarr, Radarr, Lidarr, Prowlarr, SABnzbd, Overseerr (using 11notes container images)
- **Immich**: Self-hosted photo management (via Helm chart + standalone PostgreSQL)

The infrastructure layer covers cert-manager (with Porkbun DNS-01), Intel iGPU passthrough (NFD + device plugin), NFS/local storage, network policies, and namespace configuration.

Two shell scripts handle provisioning:

- `combustion/script` -- first-boot OS-level setup (users, packages, filesystem paths)
- `scripts/bootstrap.sh` -- k3s install, age/SOPS keypair, secret encryption, Flux bootstrap

---

## What's Good

### Architecture & Structure
- **Clean Flux CD layout**: `infrastructure/{sources,controllers,configs,certs,storage}` and `apps/{media,immich}` with proper Kustomizations, dependency ordering, and SOPS decryption only where needed.
- **Dependency chain is correct**: sources -> configs -> controllers -> certs/storage -> network-policies -> apps. Each Flux Kustomization declares its `dependsOn` accurately.
- **Separation of concerns**: Combustion handles OS-level immutable provisioning; bootstrap handles cluster + GitOps. Neither overlaps the other.

### Security
- **All containers run non-root** with unique UIDs per app (10001-10009), shared GID 1500, and `runAsNonRoot: true`.
- **Read-only root filesystems** on every container, with emptyDir mounts for `/tmp` and writable paths. This matches the 11notes image design (all their READMEs state "runs read-only").
- **Capabilities are dropped**: `drop: ["ALL"]` on every container. PostgreSQL correctly adds back `SETUID`/`SETGID` (required for its initdb process).
- **Seccomp profiles** (`RuntimeDefault`) set on all pods.
- **Pod Security Admission** is properly configured: `media` and `immich` namespaces enforce `baseline` and audit/warn at `restricted`. System namespaces are exempted in the PSA config generated by bootstrap.
- **Network policies** follow default-deny with explicit allow rules for DNS, Traefik ingress, NFS egress, intra-namespace, and per-app internet access. Well-thought-out.
- **SOPS/age encryption** for secrets, with the bootstrap script handling keypair generation, `.sops.yaml` creation, and encrypted secret commits.
- **k3s hardened config**: secrets-encryption, SELinux, audit logging, PSA admission control.

### Operational Quality
- **Every container has startup/liveness/readiness probes** with appropriate endpoints (`/ping` for *arr apps, `/identity` for Plex, `pg_isready` for PostgreSQL, `tcpSocket` for SABnzbd/Overseerr).
- **Resource requests and limits** on all containers.
- **Recreate deployment strategy** on all stateful apps (correct -- avoids dual-write to config volumes).
- **Bootstrap script is idempotent** -- every step checks if already done before acting. Safe to re-run.
- **Combustion script validates placeholders** before proceeding, preventing silent misconfigurations.
- **NFS mount options** (`nfsvers=4.2, hard`) are sensible defaults.
- **Wildcard TLS via Traefik default cert store** is clean -- ingresses don't need per-service secretName references.

### Image Choices
- **11notes images are verified**: All tags exist, config paths are correct, health endpoints are confirmed from the Dockerfiles, and they explicitly support read-only root filesystems.
- **Immich PostgreSQL image** matches the official docker-compose.yml exactly (`14-vectorchord0.4.3-pgvectors0.2.0`).
- **Overseerr** uses the correct Docker Hub image (`sctx/overseerr`).

---

## Issues Found

### Bugs / Will Break

1. **Immich HelmRelease: DB env vars at the wrong level**
   `apps/immich/helmrelease.yaml:23-32` -- The `DB_HOSTNAME`, `DB_USERNAME`, `DB_DATABASE_NAME`, and `DB_PASSWORD` env vars are set under `controllers.main.containers.main.env` (top level). Due to how the Immich chart merges values, these will be injected into **all** components (server, machine-learning, valkey). The ML container and Valkey don't need DB connectivity. More importantly, the `DB_PASSWORD` secretKeyRef pointing to `immich-postgresql` will cause errors if the secret isn't available in those pods' contexts. Move these env vars under `server.controllers.main.containers.main.env` instead.

2. **Missing `DB_STORAGE_TYPE` env var on PostgreSQL**
   `apps/immich/postgresql.yaml` -- The Immich PostgreSQL entrypoint selects between SSD and HDD config templates based on the `DB_STORAGE_TYPE` env var. It's not set in the deployment, so it defaults to the entrypoint's fallback behavior (SSD). If your node uses spinning disks, you should set `DB_STORAGE_TYPE: "HDD"`. This is a minor issue if your node does use an SSD.

### Inconsistencies / Non-Ideal

3. **Lidarr image is outdated**
   `apps/media/lidarr.yaml:38` -- Uses `ghcr.io/11notes/lidarr:2.14.5` but 11notes now publishes `3.1.0`. Lidarr 3.x is a major version bump. The `2.14.5` tag still works but is no longer the latest.

4. **Plex image version anomaly**
   `apps/media/plex.yaml:38` -- Uses `ghcr.io/11notes/plex:1.43.0`. This tag exists (published 2026-01-28) but the `rolling`/`1`/`1.42` tags moved to `1.42.2` the next day. This suggests 1.43.0 may have been briefly published and reverted upstream. The pinned tag is still pullable and functional.

5. **Immich `immich-internet` network policy is too broad**
   `infrastructure/network-policies/immich.yaml:72-88` -- Uses `podSelector: {}`, granting internet access to **all** pods in the `immich` namespace (including PostgreSQL and Valkey). Consider scoping to just the server and machine-learning pods that actually need external access (for maps, model downloads).

6. **Plex network policy allows all traffic**
   `infrastructure/network-policies/media.yaml:128-139` -- `ingress: [{}]` and `egress: [{}]` effectively disables all network policy restrictions for Plex. This is intentional for remote streaming but worth being aware of -- a compromised Plex container would have unrestricted network access.

7. **Bootstrap `git commit --no-verify`**
   `scripts/bootstrap.sh:360` -- Uses `--no-verify` on the encrypted secrets commit. This is reasonable for automation but bypasses any pre-commit hooks.

### Cosmetic / Minor

8. **`.env.example` references `GITHUB_REPO="k3s-cluster"`**
   The repo is named "wilam", not "k3s-cluster". This is just a template placeholder but could confuse users.

9. **Hardcoded NAS IP in network policies**
   `infrastructure/network-policies/immich.yaml:54` and `media.yaml:54` -- Both hardcode `192.168.1.100/32` for NFS egress. The bootstrap script replaces this in `*.yaml` files, which includes network policies, so this works. But if someone changes their NAS IP later, they need to update both network policy files plus the storage PVs.

10. **Ingress hosts use placeholder domain**
    All ingress resources use `*.example.com`. The bootstrap script's `sed` replacement handles this correctly (it replaces `you@example.com` first to preserve the email, then replaces remaining `example.com` occurrences). This is fine but fragile -- if someone adds a URL containing "example.com" in a different context, the sed would mangle it.

---

## Verification Summary

| Component | Verified | Notes |
|---|---|---|
| 11notes/sonarr:4.0.16 | Tag exists, config `/sonarr/etc`, port 8989, `/ping` health | OK |
| 11notes/radarr:6.0.4 | Tag exists, config `/radarr/etc`, port 7878, `/ping` health | OK |
| 11notes/lidarr:2.14.5 | Tag exists but **outdated** (3.1.0 available) | Update recommended |
| 11notes/prowlarr:2.3.0 | Tag exists, config `/prowlarr/etc`, port 9696, `/ping` health | OK |
| 11notes/sabnzbd:4.5.5 | Tag exists, config `/sabnzbd/etc`, port 8080, tcpSocket probe | OK |
| 11notes/plex:1.43.0 | Tag exists, config `/plex/etc`, transcode `/plex/tmp`, `/identity` health | Minor version anomaly |
| sctx/overseerr:1.34.0 | Docker Hub image, port 5055 | OK |
| immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0 | Matches official docker-compose.yml | OK |
| Immich Helm chart 0.10.x | bjw-s common library chart; `server`/`machine-learning` keys correct | DB env var placement issue |
| cert-manager `crds.enabled: true` | Correct for v1.16+ (replaces deprecated `installCRDs`) | OK |
| Porkbun webhook chart | Exists at talinx.github.io, only v1.0.0 available | OK |
| PostgreSQL config_file + emptyDir | Immich entrypoint creates config before postgres starts | OK |
| Flux dependency ordering | All `dependsOn` chains are correct | OK |
| Network policies | Default-deny + explicit allows; correct for all namespaces | Immich overly broad |
| SOPS/age integration | Properly wired for immich and certs Kustomizations | OK |
| PSA configuration | Namespace labels + bootstrap PSA config are consistent | OK |
| Combustion script | Correct for Leap Micro 6.2; proper validation, idempotent | OK |
| Bootstrap script | 9-step idempotent process; validation, personalization, k3s, age, SOPS, Flux | OK |

---

## Recommendations

1. **Move DB env vars** from the top-level Immich HelmRelease values to `server.controllers.main.containers.main.env`.
2. **Update Lidarr** to `ghcr.io/11notes/lidarr:3.1.0` (or latest 3.x).
3. **Scope the `immich-internet` network policy** to specific pod labels (`app: immich-server` and `app: immich-machine-learning`) instead of all pods.
4. **Consider adding `DB_STORAGE_TYPE`** env var to the PostgreSQL deployment if your disk type matters for performance tuning.
5. **Pin the Plex image** to `1.42.2` (the current stable rolling tag) or verify that `1.43.0` works correctly in your environment.
